# ComfyUI-HaoranWanxImageEdit

[![中文版](https://img.shields.io/badge/文档-简体中文-blue.svg)](README.md)
[![English Version](https://img.shields.io/badge/Document-English-red.svg)](README - EN.md)

---

阿里云通义万相2.1图像编辑 ComfyUI 插件

## 功能介绍

本插件封装了阿里云百炼平台的 `wanx2.1-imageedit` 模型，支持以下 **10种** 图像编辑功能：

| 功能 | 说明 | 参数 |
|------|------|------|
| 全局风格化 | 将整张图像迁移至指定艺术风格 | 修改强度 |
| 局部风格化 | 仅对图像局部区域进行风格迁移 | - |
| 指令编辑 | 通过文本指令增加或修改图像内容 | 修改强度 |
| 局部重绘 | 通过mask对指定区域进行编辑 | 需要蒙版 |
| 去文字水印 | 去除图像中的中英文字符或水印 | - |
| 扩图 | 沿四个方向扩展画布并智能填充 | 上/下/左/右扩展比例 |
| 图像超分 | 提升图像清晰度并支持放大 | 超分倍数(1-4) |
| 图像上色 | 将黑白/灰度图像转为彩色 | - |
| 线稿生图 | 基于线稿生成新图像 | 涂鸦模式 |
| 卡通形象生图 | 基于卡通形象生成新图像 | - |

## 安装

1. 将本文件夹复制到 ComfyUI 的 `custom_nodes` 目录下
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 重启 ComfyUI

## 配置 API Key

### 方法一：环境变量（推荐）

设置环境变量 `DASHSCOPE_API_KEY`：

**Windows:**
```cmd
setx DASHSCOPE_API_KEY "sk-your-api-key"
```

**Linux/Mac:**
```bash
export DASHSCOPE_API_KEY="sk-your-api-key"
```

### 方法二：节点参数

在节点的 `api_key` 参数中直接输入 API Key。

### 获取 API Key

1. 访问 [阿里云百炼控制台](https://bailian.console.aliyun.com/?tab=model#/api-key)
2. 登录并创建 API Key
3. 新用户可获得 **500张免费额度**

## 使用方法

### 基础用法

1. 在节点列表中找到 `昊然` 分类
2. 添加 `Haoran 通义万相图像编辑` 节点
3. 连接输入图像
4. 选择编辑功能
5. 输入提示词
6. 运行工作流

### 节点参数说明

#### 必需参数

| 参数 | 说明 |
|------|------|
| api_key | API密钥（留空使用环境变量） |
| 图像 | 输入图像 |
| 功能 | 选择编辑功能 |
| 提示词 | 描述编辑效果 |

#### 通用参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 生成数量 | 生成图片数量(1-4) | 1 |
| 随机种子 | 用于复现结果 | 0 |
| 使用随机种子 | 是否启用种子 | 否 |
| 添加AI水印 | 添加"AI生成"水印 | 否 |
| 超时秒数 | 最大等待时间 | 180 |
| 自动调整尺寸 | 自动缩放图像至有效范围 | 是 |

#### 功能专属参数

| 参数 | 适用功能 | 说明 |
|------|----------|------|
| 修改强度 | 全局风格化、指令编辑 | 0.0-1.0，值越大修改越大 |
| 上/下/左/右扩展 | 扩图 | 扩展比例，1.0为不扩展 |
| 超分倍数 | 图像超分 | 1-4倍 |
| 涂鸦模式 | 线稿生图 | 是否为涂鸦输入 |

#### 可选参数

| 参数 | 说明 |
|------|------|
| 蒙版 | 局部重绘时需要，白色为编辑区域 |

## 提示词技巧

### 全局风格化
- 使用"转换成xx风格"的句式
- 示例：`转换成法国绘本风格`、`转换成金箔艺术风格`

### 局部风格化
- 使用"把xx变成xx风格"的句式
- 示例：`把房子变成木板风格`、`把汽车变成冰雕风格`
- 支持风格：冰雕、云朵、花灯、木板、青花瓷、毛茸茸、毛线、气球

### 指令编辑
- 明确写明"添加"、"修改"等操作
- 示例：`给她戴上一副墨镜`、`把头发颜色改为红色`

### 局部重绘
- 增加/修改：描述动作或结果
- 删除：描述删除后应出现的内容（不要写"删除xx"）
- 示例：`一只戴帽子的小狗`（在mask区域生成帽子）

### 去文字水印
- 示例：`去除图像中的文字`、`去除英文文字`

### 扩图
- 描述扩展后期望看到的完整场景
- 示例：`一家人在公园草坪上野餐`

### 图像上色
- 可留空自动上色
- 或指定颜色：`蓝色背景，黄色的叶子`

### 线稿生图
- 详细描述期望生成的图像内容
- 涂鸦模式：输入为手绘涂鸦，直接基于涂鸦生成
- 非涂鸦模式：输入为普通图像，先提取线稿再生成

### 卡通形象生图
- 使用"卡通形象..."的句式
- 示例：`卡通形象小心翼翼地探出头，窥视着房间内的宝石`

## 图像要求

- **格式**：JPG、JPEG、PNG、BMP、TIFF、WEBP
- **分辨率**：512-4096 像素（宽/高）
- **大小**：不超过 10MB
- 开启"自动调整尺寸"可自动处理不符合要求的图像

## 计费说明

- **价格**：0.14 元/张
- **免费额度**：500 张（新用户）
- **限流**：RPS=2，同时处理任务数=2

## 常见问题

### Q: 任务超时怎么办？
A: 增加"超时秒数"参数，或检查网络连接。

### Q: 报错"DataInspectionFailed"？
A: 输入或生成内容触发了内容安全策略，请修改提示词或输入图像。

### Q: 结果图像URL过期？
A: 结果URL有效期24小时，请及时保存。

## 更新日志

### v1.0.0 (2026-01-07)
- 首次发布
- 支持10种图像编辑功能
- 完整的错误处理和重试机制
- 中文友好的参数命名

## 相关链接

- [阿里云百炼平台](https://bailian.console.aliyun.com/)
- [API文档](https://help.aliyun.com/zh/model-studio/wanx-image-edit)
- [API参考](https://help.aliyun.com/zh/model-studio/wanx-image-edit-api-reference)

## 许可证

MIT License



